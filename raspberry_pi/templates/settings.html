{% extends "layout.html" %}

{% block title %}Settings - Prayer Alarm System{% endblock %}

{% block content %}
<h1>System Settings</h1>

<div class="card">
    <div class="card-header">
        <h2>Upload New Adhan Sound</h2>
    </div>
    <div class="card-content">
        <div class="upload-area" id="adhan-upload-area">
            <div class="upload-icon">
                <i class="fas fa-mosque"></i>
            </div>
            <p>Drag and drop an adhan MP3 file here or click to browse</p>
            <input type="file" id="adhan-file" accept=".mp3" style="display: none;">
        </div>
        <button id="upload-adhan-button" class="btn btn-primary" style="margin-top: 10px;">
            <i class="fas fa-mosque"></i> Upload Adhan Sound
        </button>
        <div class="upload-progress" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <p class="progress-text">Uploading... 0%</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Adhan (Prayer Call) Settings</h2>
    </div>
    <div class="card-content">
        <div class="form-group">
            <label for="default-adhan">Default Adhan Sound</label>
            <div class="sound-selector">
                <select id="default-adhan" class="form-control">
                    {% for sound in adhan_sounds %}
                    <option value="{{ sound.path }}" {% if sound.path == default_adhan %}selected{% endif %}>{{ sound.name }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-secondary" onclick="testAdhan()">
                    <i class="fas fa-play"></i> Test
                </button>
            </div>
        </div>

        <h3>Custom Adhan for Each Prayer</h3>
        <div class="prayer-adhan-settings">
            {% for prayer in prayers %}
            <div class="form-group">
                <label for="adhan-{{ prayer.name|lower }}">{{ prayer.name }}</label>
                <div class="sound-selector">
                    <select id="adhan-{{ prayer.name|lower }}" class="form-control prayer-adhan-selector" data-prayer="{{ prayer.name }}">
                        <option value="">Use Default</option>
                        {% for sound in adhan_sounds %}
                        <option value="{{ sound.path }}" {% if sound.path == prayer.custom_sound %}selected{% endif %}>{{ sound.name }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-secondary" onclick="testAdhanForPrayer('{{ prayer.name }}')">
                        <i class="fas fa-play"></i> Test
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Pre-Adhan and Tahrim Sound Settings</h2>
    </div>
    <div class="card-content">
        <p>Configure sounds to play before the adhan and tahrim sounds that follow announcements</p>
        
        <h3>Pre-Adhan and Tahrim Sounds for Each Prayer</h3>
        <div class="prayer-adhan-settings">
            {% for prayer in prayers %}
            <div class="form-group">
                <h4>{{ prayer.name }} Prayer</h4>
                
                <!-- 10-minute pre-adhan announcement -->
                <div class="sound-setting-group">
                    <label for="pre-adhan-10-{{ prayer.name|lower }}">10-minute Pre-Adhan Sound</label>
                    <div class="sound-selector">
                        <select id="pre-adhan-10-{{ prayer.name|lower }}" class="form-control pre-adhan-10-selector" data-prayer="{{ prayer.name }}">
                            <option value="">None (No 10-minute announcement)</option>
                            {% for sound in adhan_sounds %}
                            <option value="{{ sound.path }}" {% if sound.path == prayer.pre_adhan_10_min %}selected{% endif %}>{{ sound.name }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-secondary" onclick="testPreAdhan10({{ prayer.id }}, '{{ prayer.name }}')">
                            <i class="fas fa-play"></i> Test
                        </button>
                    </div>
                </div>
                
                <!-- 5-minute pre-adhan announcement -->
                <div class="sound-setting-group">
                    <label for="pre-adhan-5-{{ prayer.name|lower }}">5-minute Pre-Adhan Sound</label>
                    <div class="sound-selector">
                        <select id="pre-adhan-5-{{ prayer.name|lower }}" class="form-control pre-adhan-5-selector" data-prayer="{{ prayer.name }}">
                            <option value="">None (No 5-minute announcement)</option>
                            {% for sound in adhan_sounds %}
                            <option value="{{ sound.path }}" {% if sound.path == prayer.pre_adhan_5_min %}selected{% endif %}>{{ sound.name }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-secondary" onclick="testPreAdhan5({{ prayer.id }}, '{{ prayer.name }}')">
                            <i class="fas fa-play"></i> Test
                        </button>
                    </div>
                </div>
                
                <!-- Tahrim sound -->
                <div class="sound-setting-group">
                    <label for="tahrim-{{ prayer.name|lower }}">Tahrim Sound After Announcement</label>
                    <div class="sound-selector">
                        <select id="tahrim-{{ prayer.name|lower }}" class="form-control tahrim-selector" data-prayer="{{ prayer.name }}">
                            <option value="">None (No tahrim sound)</option>
                            {% for sound in adhan_sounds %}
                            <option value="{{ sound.path }}" {% if sound.path == prayer.tahrim_sound %}selected{% endif %}>{{ sound.name }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-secondary" onclick="testTahrim({{ prayer.id }}, '{{ prayer.name }}')">
                            <i class="fas fa-play"></i> Test
                        </button>
                    </div>
                </div>
                
                <hr>
            </div>
            {% endfor %}
        </div>
    </div>
</div>



<div class="card">
    <div class="card-header">
        <h2>Location Settings</h2>
    </div>
    <div class="card-content">
        <div class="form-group">
            <label for="prayer-city">City</label>
            <input type="text" id="prayer-city" class="form-control" value="{{ prayer_city }}" placeholder="Jakarta">
        </div>
        <div class="form-group">
            <label for="prayer-country">Country</label>
            <input type="text" id="prayer-country" class="form-control" value="{{ prayer_country }}" placeholder="Indonesia">
        </div>
        <div class="form-group">
            <label for="calculation-method">Prayer Time Calculation Method</label>
            <select id="calculation-method" class="form-control">
                <option value="0" {% if calculation_method == 0 %}selected{% endif %}>Shia Ithna-Ashari</option>
                <option value="1" {% if calculation_method == 1 %}selected{% endif %}>University of Islamic Sciences, Karachi</option>
                <option value="2" {% if calculation_method == 2 %}selected{% endif %}>Islamic Society of North America</option>
                <option value="3" {% if calculation_method == 3 %}selected{% endif %}>Muslim World League</option>
                <option value="4" {% if calculation_method == 4 %}selected{% endif %}>Umm al-Qura University, Makkah</option>
                <option value="5" {% if calculation_method == 5 %}selected{% endif %}>Egyptian General Authority of Survey</option>
                <option value="7" {% if calculation_method == 7 %}selected{% endif %}>Institute of Geophysics, University of Tehran</option>
                <option value="11" {% if calculation_method == 11 %}selected{% endif %}>Indonesian Ministry of Religious Affairs</option>
                <option value="12" {% if calculation_method == 12 %}selected{% endif %}>Union des organisations islamiques de France</option>
                <option value="13" {% if calculation_method == 13 %}selected{% endif %}>Spiritual Administration of Muslims of Russia</option>
            </select>
        </div>
        <button id="save-location" class="btn">Save Location Settings</button>
        <button id="refresh-prayer-times" class="btn btn-secondary">Refresh Prayer Times</button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>System Preferences</h2>
    </div>
    <div class="card-content">
        <div class="form-group">
            <label for="volume">System Volume</label>
            <input type="range" id="volume" class="form-control" min="0" max="100" value="{{ volume }}">
            <span id="volume-value">{{ volume }}%</span>
        </div>
        <button id="save-preferences" class="btn">Save Preferences</button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>YouTube Videos</h2>
    </div>
    <div class="card-content">
        <div class="youtube-form">
            <div class="form-group">
                <label for="youtube-url">YouTube Video URL</label>
                <input type="text" id="youtube-url" class="form-control" placeholder="https://www.youtube.com/watch?v=...">
            </div>
            <div class="form-group">
                <label for="youtube-title">Title (Optional)</label>
                <input type="text" id="youtube-title" class="form-control" placeholder="Custom title for this video">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="youtube-enabled" checked>
                    Enable this video
                </label>
            </div>
            <button id="add-youtube-video" class="btn">Add YouTube Video</button>
        </div>
        
        <h3>Manage YouTube Videos</h3>
        <div class="youtube-list" id="youtube-list">
            {% if youtube_videos %}
                {% for video in youtube_videos %}
                <div class="youtube-item" data-id="{{ video.id }}">
                    <div class="youtube-item-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <div class="youtube-item-title">
                        {{ video.title or video.url }}
                    </div>
                    <div class="youtube-item-controls">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>
                                <input type="checkbox" class="youtube-item-enabled" 
                                       {% if video.enabled %}checked{% endif %}
                                       onchange="updateYouTubeVideo({{ video.id }}, this)">
                                Enabled
                            </label>
                        </div>
                        <button class="btn btn-sm" onclick="editYouTubeVideo({{ video.id }})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteYouTubeVideo({{ video.id }})">Delete</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="no-videos">No YouTube videos added yet.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize volume slider
    const volumeSlider = document.getElementById('volume');
    const volumeValue = document.getElementById('volume-value');
    
    volumeSlider.addEventListener('input', function() {
        volumeValue.textContent = volumeSlider.value + '%';
    });
    
    // Setup adhan upload functionality
    const adhanUploadArea = document.getElementById('adhan-upload-area');
    const adhanFileInput = document.getElementById('adhan-file');
    const uploadAdhanButton = document.getElementById('upload-adhan-button');
    
    adhanUploadArea.addEventListener('click', function() {
        adhanFileInput.click();
    });
    
    uploadAdhanButton.addEventListener('click', function() {
        adhanFileInput.click();
    });
    
    adhanUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        adhanUploadArea.classList.add('drag-over');
    });
    
    adhanUploadArea.addEventListener('dragleave', function() {
        adhanUploadArea.classList.remove('drag-over');
    });
    
    adhanUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        adhanUploadArea.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length) {
            uploadAdhanFile(e.dataTransfer.files[0]);
        }
    });
    
    adhanFileInput.addEventListener('change', function() {
        if (adhanFileInput.files.length) {
            uploadAdhanFile(adhanFileInput.files[0]);
        }
    });
    
    // Handle default adhan selection
    document.getElementById('default-adhan').addEventListener('change', function() {
        setDefaultAdhan(this.value);
    });
    
    // Handle prayer-specific adhan selection
    document.querySelectorAll('.prayer-adhan-selector').forEach(function(selector) {
        selector.addEventListener('change', function() {
            const prayer = this.getAttribute('data-prayer');
            const sound = this.value;
            setAdhanForPrayer(prayer, sound);
        });
    });
    
    // Handle 10-minute pre-adhan sound selection
    document.querySelectorAll('.pre-adhan-10-selector').forEach(function(selector) {
        selector.addEventListener('change', function() {
            const prayer = this.getAttribute('data-prayer');
            const sound = this.value;
            setPreAdhan10ForPrayer(prayer, sound);
        });
    });
    
    // Handle 5-minute pre-adhan sound selection
    document.querySelectorAll('.pre-adhan-5-selector').forEach(function(selector) {
        selector.addEventListener('change', function() {
            const prayer = this.getAttribute('data-prayer');
            const sound = this.value;
            setPreAdhan5ForPrayer(prayer, sound);
        });
    });
    
    // Handle tahrim sound selection
    document.querySelectorAll('.tahrim-selector').forEach(function(selector) {
        selector.addEventListener('change', function() {
            const prayer = this.getAttribute('data-prayer');
            const sound = this.value;
            setTahrimForPrayer(prayer, sound);
        });
    });
    
    // Location settings
    document.getElementById('save-location').addEventListener('click', saveLocationSettings);
    document.getElementById('refresh-prayer-times').addEventListener('click', refreshPrayerTimes);
    
    // System preferences
    document.getElementById('save-preferences').addEventListener('click', savePreferences);
});

// Function to test default adhan
function testAdhan() {
    fetch('/adhan/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Playing default adhan', 'success');
        } else {
            showNotification('Error playing adhan', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error playing adhan', 'error');
    });
}

// Function to test prayer-specific adhan
function testAdhanForPrayer(prayer) {
    fetch('/adhan/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ prayer_name: prayer })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(`Playing adhan for ${prayer}`, 'success');
        } else {
            showNotification('Error playing adhan', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error playing adhan', 'error');
    });
}

// Function to set default adhan
function setDefaultAdhan(soundPath) {
    fetch('/adhan/default', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ sound_path: soundPath })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Default adhan sound updated', 'success');
        } else {
            showNotification('Error updating default adhan', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating default adhan', 'error');
    });
}

// Function to set adhan for a specific prayer
function setAdhanForPrayer(prayer, soundPath) {
    fetch('/adhan/prayer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prayer_name: prayer,
            sound_path: soundPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(`Adhan for ${prayer} updated`, 'success');
        } else {
            showNotification('Error updating adhan for prayer', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating adhan for prayer', 'error');
    });
}

// Function to set 10-minute pre-adhan sound for a specific prayer
function setPreAdhan10ForPrayer(prayer, soundPath) {
    fetch('/pre-adhan/10-min', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prayer_name: prayer,
            sound_path: soundPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(`10-minute pre-adhan sound for ${prayer} updated`, 'success');
        } else {
            showNotification('Error updating pre-adhan sound', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating pre-adhan sound', 'error');
    });
}

// Function to set 5-minute pre-adhan sound for a specific prayer
function setPreAdhan5ForPrayer(prayer, soundPath) {
    fetch('/pre-adhan/5-min', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prayer_name: prayer,
            sound_path: soundPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(`5-minute pre-adhan sound for ${prayer} updated`, 'success');
        } else {
            showNotification('Error updating pre-adhan sound', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating pre-adhan sound', 'error');
    });
}

// Function to set tahrim sound for a specific prayer
function setTahrimForPrayer(prayer, soundPath) {
    fetch('/pre-adhan/tahrim', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prayer_name: prayer,
            sound_path: soundPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(`Tahrim sound for ${prayer} updated`, 'success');
        } else {
            showNotification('Error updating tahrim sound', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating tahrim sound', 'error');
    });
}

// Function to test 10-minute pre-adhan sound
function testPreAdhan10(prayerId, prayerName) {
    fetch('/pre-adhan/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prayer_id: prayerId,
            prayer_name: prayerName,
            sound_type: 'pre_adhan_10_min'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(`Playing 10-minute pre-adhan sound for ${prayerName}`, 'success');
        } else {
            showNotification('Error playing pre-adhan sound', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error playing pre-adhan sound', 'error');
    });
}

// Function to test 5-minute pre-adhan sound
function testPreAdhan5(prayerId, prayerName) {
    fetch('/pre-adhan/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prayer_id: prayerId,
            prayer_name: prayerName,
            sound_type: 'pre_adhan_5_min'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(`Playing 5-minute pre-adhan sound for ${prayerName}`, 'success');
        } else {
            showNotification('Error playing pre-adhan sound', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error playing pre-adhan sound', 'error');
    });
}

// Function to test tahrim sound
function testTahrim(prayerId, prayerName) {
    fetch('/pre-adhan/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            prayer_id: prayerId,
            prayer_name: prayerName,
            sound_type: 'tahrim_sound'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification(`Playing tahrim sound for ${prayerName}`, 'success');
        } else {
            showNotification('Error playing tahrim sound', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error playing tahrim sound', 'error');
    });
}

// Function to upload adhan file
function uploadAdhanFile(file) {
    if (!file.type.match('audio/mp3') && !file.type.match('audio/mpeg')) {
        showNotification('Please select an MP3 file', 'error');
        return;
    }
    
    const uploadArea = document.getElementById('adhan-upload-area');
    const progressContainer = document.querySelector('.upload-progress');
    const progressFill = document.querySelector('.progress-fill');
    const progressText = document.querySelector('.progress-text');
    
    uploadArea.style.display = 'none';
    progressContainer.style.display = 'block';
    
    // Convert file to base64
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = function() {
        // Extract the base64 data (remove data:audio/mp3;base64, prefix)
        const base64data = reader.result.split(',')[1];
        
        // Prepare the JSON payload
        const payload = {
            file_name: file.name,
            file_content: base64data
        };
        
        // Send the file to the server
        fetch('/adhan/upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            console.log('Adhan upload response status:', response.status);
            return response.json().then(data => {
                return {
                    status: response.status,
                    data: data
                };
            });
        })
        .then(result => {
            uploadArea.style.display = 'block';
            progressContainer.style.display = 'none';
            
            // Clear progress interval
            clearInterval(progressInterval);
            
            console.log('Adhan upload result:', result);
            
            if (result.status === 200 && result.data.status === 'success') {
                // Show a more prominent success message
                const successMessage = `Adhan sound "${file.name}" uploaded successfully!`;
                showNotification(successMessage, 'success');
                
                // Add a delay before reload to ensure the notification is seen
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                // Show a more detailed error message
                const errorMessage = `Error uploading adhan: ${
                    result.data && result.data.message ? result.data.message : 'Server error'
                }`;
                showNotification(errorMessage, 'error');
                console.error('Upload error:', result);
            }
        })
        .catch(error => {
            console.error('Adhan upload error:', error);
            uploadArea.style.display = 'block';
            progressContainer.style.display = 'none';
            
            // Clear progress interval
            clearInterval(progressInterval);
            
            // Show a more detailed error message
            showNotification('Network error during adhan upload. Please try again.', 'error');
        });
    };
    
    reader.onerror = function(error) {
        console.error('Error reading file:', error);
        uploadArea.style.display = 'block';
        progressContainer.style.display = 'none';
        showNotification('Error reading file', 'error');
    };
    
    // Simulate upload progress (since we don't have a real progress event)
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 5;
        if (progress > 90) clearInterval(progressInterval);
        
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `Uploading... ${progress}%`;
    }, 200);
}

// Function to save location settings
function saveLocationSettings() {
    const city = document.getElementById('prayer-city').value;
    const country = document.getElementById('prayer-country').value;
    const calculationMethod = document.getElementById('calculation-method').value;
    
    fetch('/settings/location', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            city: city,
            country: country,
            calculation_method: parseInt(calculationMethod)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Location settings saved', 'success');
        } else {
            showNotification('Error saving location settings', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error saving location settings', 'error');
    });
}

// Function to refresh prayer times
function refreshPrayerTimes() {
    fetch('/prayer-times/refresh', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Prayer times refreshed successfully', 'success');
        } else {
            showNotification('Error refreshing prayer times', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error refreshing prayer times', 'error');
    });
}

// Function to save system preferences
function savePreferences() {
    const volume = document.getElementById('volume').value;
    
    fetch('/settings/preferences', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            volume: parseInt(volume)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Preferences saved', 'success');
        } else {
            showNotification('Error saving preferences', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error saving preferences', 'error');
    });
}

// YouTube video functions
document.addEventListener('DOMContentLoaded', function() {
    // Add YouTube video button
    document.getElementById('add-youtube-video').addEventListener('click', addYouTubeVideo);
    
    // Initialize sortable for YouTube videos
    if (typeof Sortable !== 'undefined') {
        const youtubeList = document.getElementById('youtube-list');
        if (youtubeList) {
            new Sortable(youtubeList, {
                handle: '.youtube-item-handle',
                animation: 150,
                onEnd: function() {
                    // Get new order of videos
                    const videoIds = [];
                    document.querySelectorAll('.youtube-item').forEach(item => {
                        videoIds.push(parseInt(item.getAttribute('data-id')));
                    });
                    
                    // Update order in database
                    if (videoIds.length > 0) {
                        reorderYouTubeVideos(videoIds);
                    }
                }
            });
        }
    }
});

// Function to add a new YouTube video
function addYouTubeVideo() {
    const urlInput = document.getElementById('youtube-url');
    const titleInput = document.getElementById('youtube-title');
    const enabledInput = document.getElementById('youtube-enabled');
    
    const url = urlInput.value.trim();
    const title = titleInput.value.trim();
    const enabled = enabledInput.checked;
    
    if (!url) {
        showNotification('Please enter a YouTube URL', 'error');
        return;
    }
    
    // Validate YouTube URL
    if (!isValidYouTubeUrl(url)) {
        showNotification('Please enter a valid YouTube URL', 'error');
        return;
    }
    
    fetch('/youtube-videos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            url: url,
            title: title,
            enabled: enabled
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('YouTube video added successfully', 'success');
            
            // Clear inputs
            urlInput.value = '';
            titleInput.value = '';
            
            // Reload the page to show the new video
            window.location.reload();
        } else {
            showNotification('Error adding YouTube video: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error adding YouTube video', 'error');
    });
}

// Function to update a YouTube video
function updateYouTubeVideo(videoId, enabledCheckbox) {
    const enabled = enabledCheckbox.checked;
    
    fetch(`/youtube-videos/${videoId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            enabled: enabled
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('YouTube video updated', 'success');
        } else {
            showNotification('Error updating YouTube video', 'error');
            // Revert checkbox state
            enabledCheckbox.checked = !enabled;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating YouTube video', 'error');
        // Revert checkbox state
        enabledCheckbox.checked = !enabled;
    });
}

// Function to edit a YouTube video
function editYouTubeVideo(videoId) {
    // Get the video item
    const videoItem = document.querySelector(`.youtube-item[data-id="${videoId}"]`);
    if (!videoItem) return;
    
    // Get the current title and URL from the item
    const titleElement = videoItem.querySelector('.youtube-item-title');
    const currentTitle = titleElement.textContent.trim();
    
    // Create a simple modal for editing
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit YouTube Video</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-youtube-title">Title</label>
                    <input type="text" id="edit-youtube-title" class="form-control" value="${currentTitle}">
                </div>
                <div class="form-group">
                    <label for="edit-youtube-url">URL</label>
                    <input type="text" id="edit-youtube-url" class="form-control" placeholder="https://www.youtube.com/watch?v=...">
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal-save" class="btn">Save Changes</button>
                <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Show modal
    modal.style.display = 'block';
    
    // Close modal when clicking the close button or outside the modal
    const closeBtn = modal.querySelector('.close');
    closeBtn.onclick = function() {
        document.body.removeChild(modal);
    };
    
    window.onclick = function(event) {
        if (event.target === modal) {
            document.body.removeChild(modal);
        }
    };
    
    // Cancel button
    const cancelBtn = modal.querySelector('#modal-cancel');
    cancelBtn.onclick = function() {
        document.body.removeChild(modal);
    };
    
    // Save button
    const saveBtn = modal.querySelector('#modal-save');
    saveBtn.onclick = function() {
        const newTitle = modal.querySelector('#edit-youtube-title').value.trim();
        const newUrl = modal.querySelector('#edit-youtube-url').value.trim();
        
        // Prepare the update data
        const updateData = {};
        if (newTitle !== currentTitle) updateData.title = newTitle;
        if (newUrl && isValidYouTubeUrl(newUrl)) updateData.url = newUrl;
        
        if (Object.keys(updateData).length === 0) {
            document.body.removeChild(modal);
            return;
        }
        
        // Send update request
        fetch(`/youtube-videos/${videoId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification('YouTube video updated', 'success');
                // Update the title in the DOM
                if (updateData.title) {
                    titleElement.textContent = updateData.title;
                }
                document.body.removeChild(modal);
                
                // If URL was updated, reload the page
                if (updateData.url) {
                    window.location.reload();
                }
            } else {
                showNotification('Error updating YouTube video', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error updating YouTube video', 'error');
        });
    };
}

// Function to delete a YouTube video
function deleteYouTubeVideo(videoId) {
    if (!confirm('Are you sure you want to delete this YouTube video?')) {
        return;
    }
    
    fetch(`/youtube-videos/${videoId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('YouTube video deleted', 'success');
            
            // Remove the video item from the DOM
            const videoItem = document.querySelector(`.youtube-item[data-id="${videoId}"]`);
            if (videoItem) {
                videoItem.remove();
            }
            
            // If no videos left, show no videos message
            const youtubeList = document.getElementById('youtube-list');
            if (youtubeList.children.length === 0) {
                youtubeList.innerHTML = '<p class="no-videos">No YouTube videos added yet.</p>';
            }
        } else {
            showNotification('Error deleting YouTube video', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error deleting YouTube video', 'error');
    });
}

// Function to reorder YouTube videos
function reorderYouTubeVideos(videoIds) {
    fetch('/youtube-videos/reorder', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            video_ids: videoIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('YouTube videos reordered', 'success');
        } else {
            showNotification('Error reordering YouTube videos', 'error');
            // Reload the page to reset the order
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error reordering YouTube videos', 'error');
        // Reload the page to reset the order
        window.location.reload();
    });
}

// Helper function to validate YouTube URL
function isValidYouTubeUrl(url) {
    if (!url) return false;
    
    // Check using regular expressions
    const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/,  // Standard and shortened URLs
        /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,  // Embed URLs
        /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/  // Old embed URLs
    ];
    
    for (const pattern of patterns) {
        if (pattern.test(url)) {
            return true;
        }
    }
    
    return false;
}
</script>
{% endblock %}