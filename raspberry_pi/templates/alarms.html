{% extends "layout.html" %}

{% block title %}Alarms - Prayer Alarm System{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Alarms</h2>
        <a href="{{ url_for('web_add_alarm') }}" class="btn">Add New Alarm</a>
    </div>
    
    <div id="alarms-container">
        <div id="alarms-list">
            Loading alarms...
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fetch all alarms
    async function fetchAlarms() {
        try {
            const response = await fetch('/alarms');
            const alarms = await response.json();
            
            const alarmsList = document.getElementById('alarms-list');
            
            if (alarms.length > 0) {
                let html = '<table>';
                html += `
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Repeat</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                alarms.forEach(alarm => {
                    let timeString = '';
                    
                    // Handle the time display with proper validation
                    if (alarm.time_in_millis && !isNaN(alarm.time_in_millis)) {
                        // Valid timestamp
                        const time = new Date(parseInt(alarm.time_in_millis));
                        if (!isNaN(time.getTime())) {
                            timeString = time.toLocaleTimeString('en-US', { 
                                hour: '2-digit', 
                                minute: '2-digit'
                            });
                        }
                    }
                    
                    // Fallback for invalid dates
                    if (!timeString) {
                        // Try to extract time from time_str if available
                        if (alarm.time_str) {
                            timeString = alarm.time_str;
                        } else {
                            timeString = "N/A";
                        }
                    }
                    
                    let repeatText = 'One Time';
                    if (alarm.repeating) {
                        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        const repeatDays = [];
                        alarm.days.forEach((enabled, index) => {
                            if (enabled) {
                                repeatDays.push(days[index]);
                            }
                        });
                        repeatText = repeatDays.join(', ');
                    }
                    
                    html += `
                        <tr>
                            <td>${timeString}</td>
                            <td>${alarm.enabled ? 'Enabled' : 'Disabled'}</td>
                            <td>${repeatText}</td>
                            <td>
                                <button class="btn btn-icon btn-danger delete-alarm" data-id="${alarm.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-icon ${alarm.enabled ? 'btn-secondary' : 'btn'} toggle-alarm" data-id="${alarm.id}" data-enabled="${alarm.enabled}">
                                    <i class="fas ${alarm.enabled ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                alarmsList.innerHTML = html;
                
                // Add event listeners to the buttons
                document.querySelectorAll('.delete-alarm').forEach(button => {
                    button.addEventListener('click', async function() {
                        const id = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this alarm?')) {
                            await deleteAlarm(id);
                        }
                    });
                });
                
                document.querySelectorAll('.toggle-alarm').forEach(button => {
                    button.addEventListener('click', async function() {
                        const id = this.getAttribute('data-id');
                        const enabled = this.getAttribute('data-enabled') === 'true';
                        await toggleAlarm(id, enabled);
                    });
                });
            } else {
                alarmsList.innerHTML = '<p>No alarms set</p>';
            }
        } catch (error) {
            console.error('Error fetching alarms:', error);
            document.getElementById('alarms-list').innerHTML = '<p>Error loading alarms</p>';
        }
    }
    
    // Delete an alarm
    async function deleteAlarm(id) {
        try {
            // First update the UI to show the deletion is in progress
            const alarmRow = document.querySelector(`button.delete-alarm[data-id="${id}"]`).closest('tr');
            if (alarmRow) {
                alarmRow.style.opacity = '0.5';
                alarmRow.style.backgroundColor = '#ffeeee';
            }
            
            const response = await fetch(`/alarms/${id}`, { method: 'DELETE' });
            const result = await response.json();
            
            if (result.status === 'success') {
                showNotification('Alarm deleted');
                
                // Remove the row from the UI immediately without requiring a full refresh
                if (alarmRow) {
                    alarmRow.remove();
                    
                    // Check if we have any alarms left
                    const remainingRows = document.querySelectorAll('#alarms-list tbody tr');
                    if (remainingRows.length === 0) {
                        document.getElementById('alarms-list').innerHTML = '<p>No alarms set</p>';
                    }
                } else {
                    // Fallback: if we couldn't find the row for some reason, refresh the entire list
                    fetchAlarms();
                }
            }
        } catch (error) {
            console.error('Error deleting alarm:', error);
            // If there's an error, refresh the entire list to ensure it's in a consistent state
            fetchAlarms();
        }
    }
    
    // Toggle alarm enabled/disabled
    async function toggleAlarm(id, currentlyEnabled) {
        try {
            // First update the UI to show the action is in progress
            const toggleButton = document.querySelector(`button.toggle-alarm[data-id="${id}"]`);
            const alarmRow = toggleButton ? toggleButton.closest('tr') : null;
            
            if (alarmRow) {
                alarmRow.style.opacity = '0.7';
            }
            
            let response;
            if (currentlyEnabled) {
                response = await fetch(`/alarms/${id}/disable`, { method: 'POST' });
            } else {
                // Currently we don't have an enable endpoint, so we'd need to update the alarm
                showNotification('Enabling alarms is not supported in the web interface yet', 'error');
                if (alarmRow) {
                    alarmRow.style.opacity = '1';
                }
                return;
            }
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showNotification(`Alarm ${currentlyEnabled ? 'disabled' : 'enabled'}`);
                
                // Update the UI immediately without requiring a full refresh
                if (toggleButton) {
                    // Update button appearance
                    toggleButton.classList.remove(currentlyEnabled ? 'btn-secondary' : 'btn');
                    toggleButton.classList.add(currentlyEnabled ? 'btn' : 'btn-secondary');
                    toggleButton.setAttribute('data-enabled', !currentlyEnabled);
                    
                    // Update icon
                    const icon = toggleButton.querySelector('i');
                    if (icon) {
                        icon.classList.remove(currentlyEnabled ? 'fa-toggle-on' : 'fa-toggle-off');
                        icon.classList.add(currentlyEnabled ? 'fa-toggle-off' : 'fa-toggle-on');
                    }
                    
                    // Update status cell
                    const statusCell = alarmRow.querySelector('td:nth-child(2)');
                    if (statusCell) {
                        statusCell.textContent = currentlyEnabled ? 'Disabled' : 'Enabled';
                    }
                    
                    // Restore normal appearance
                    alarmRow.style.opacity = '1';
                } else {
                    // Fallback: if we couldn't find the button for some reason, refresh the entire list
                    fetchAlarms();
                }
            }
        } catch (error) {
            console.error('Error toggling alarm:', error);
            // If there's an error, refresh the entire list to ensure it's in a consistent state
            fetchAlarms();
        }
    }
    
    // Initial fetch
    fetchAlarms();
});
</script>
{% endblock %}
